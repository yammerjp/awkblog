<html>
  <head>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.0/dist/browser-image-compression.js"></script>
    <script type="text/javascript" src="/assets/uploadImage.js"></script>
    <style>
      #input-image {
        display: none;
      }
      textarea:not(.dragover) {
        padding: 2px;
      }
      textarea.dragover {
        box-sizing :border-box;
        border: dashed 3px #ccc;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <h1>hello, awkblog!</h1>
    <div>username: <%= v["username"] %></div>
    <form action="/authed/posts/new" method="post">
      <div><label>title:<br><input type="text" name="title"></label></div>
      <div><label>content:<br><textarea name="content" id="textarea-of-article"></textarea></label></div>
      <button type="button" id="button-to-add-image">click to add a image</button>
      <input type="file" id="input-image" accept="image/jpeg,image/png,image/gif,image/webp">
      <input type="hidden" name="zpadding" value="0">
      <div><input type="submit" value="投稿する"></div>
    </form>
    <script>
      const buttonToAddImage = document.getElementById("button-to-add-image")
      const inputImage = document.getElementById("input-image")
      const textareaOfArticle = document.getElementById("textarea-of-article")

      buttonToAddImage.addEventListener("click", () => {
        inputImage.click()
      })
      inputImage.addEventListener("change", (event) => {
        event.preventDefault()
        upload(event.target.files[0])
      })

      const startDragOver = (event) => {
        event.preventDefault()
        event.target.classList.add('dragover')
      }
      const endDragOver = (event) => {
        event.preventDefault()
        event.target.classList.remove('dragover')
      }
      textareaOfArticle.addEventListener('dragenter', startDragOver)
      textareaOfArticle.addEventListener('dragover', startDragOver)
      textareaOfArticle.addEventListener('dragleave', endDragOver)
      textareaOfArticle.addEventListener('dragend', endDragOver)
      textareaOfArticle.addEventListener('drop', function(event) {
        endDragOver(event)
        const files = event?.dataTransfer?.files; // FileList object.
        if (files === undefined) {
          alert("only support to drop files")
          return
        }
        upload(files[0])
      })

      const upload = (file) => {
        const acceptedImageTypes = inputImage.getAttribute('accept').split(',')
        if (!acceptedImageTypes.some(type => file.type.match(type))) {
          alert(`only support ${acceptedImageTypes.join(',')}`)
          return
        }

        uploadImage(
          file,
          () => {}
          // function (message) { console.log("uploadImage(): " + message) }
        ).then(imageUrl => {
          textareaOfArticle.setRangeText(
            `![image](${imageUrl})`,
            textareaOfArticle.selectionStart,
            textareaOfArticle.selectionStart,
            'end'
          )
        }).catch(e => {
          // console.error(`catched ${e}`)
          alert('failed to upload a image')
        })
      }
    </script>
  </body>
</html>

